<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AapdaSetu | Citizen Safety</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .mobile-container { max-width: 500px; margin: 0 auto; background: #fff; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); position: relative; }
        
        /* STATUS STYLES */
        .status-safe { background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); color: white; padding: 40px 20px; border-radius: 0 0 30px 30px; text-align: center; transition: 0.5s; }
        .status-danger { background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%); color: white; padding: 40px 20px; border-radius: 0 0 30px 30px; text-align: center; animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 71, 58, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 71, 58, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 71, 58, 0); } }
        
        /* CHAT & BUTTONS */
        .chat-interface { background: #f8f9fa; border-radius: 15px; height: 350px; display: flex; flex-direction: column; }
        .chat-history { flex-grow: 1; overflow-y: auto; padding: 15px; }
        
        /* Chat Bubbles */
        .bot-msg { background: #e9ecef; padding: 10px 15px; border-radius: 15px 15px 15px 0; display: inline-block; margin-bottom: 10px; font-size: 0.9rem; max-width: 85%; }
        .user-msg { background: #0d6efd; color: white; padding: 10px 15px; border-radius: 15px 15px 0 15px; display: inline-block; margin-bottom: 10px; float: right; clear: both; font-size: 0.9rem; max-width: 85%; }
        
        /* Typing Indicator */
        .typing { font-style: italic; color: #888; font-size: 0.8rem; margin-left: 10px; display: none; }
    </style>
</head>
<body>

<div class="mobile-container">
    <div id="status-header" class="status-safe">
        <div class="d-flex justify-content-between mb-3">
            <small id="geo-text"><i class="bi bi-geo-alt-fill"></i> Locating...</small>
            <span class="badge bg-white text-dark" id="distance-badge" style="display:none">0 km away</span>
        </div>
        <div id="status-content">
            <i class="bi bi-shield-check display-1 mb-2"></i>
            <h2 class="fw-bold">You are Safe</h2>
            <p class="opacity-75">No active threats in your zone.</p>
        </div>
    </div>

    <div class="p-3">
        <div class="d-grid gap-2 mb-4">
            <button class="btn btn-warning btn-lg fw-bold py-3 shadow-sm" data-bs-toggle="modal" data-bs-target="#reportModal">
                <i class="bi bi-camera-video-fill me-2"></i> REPORT INCIDENT
            </button>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 fw-bold d-flex justify-content-between">
                <span><i class="bi bi-robot text-primary"></i> AapdaSetu AI</span>
                <span class="badge bg-light text-dark border">AI Chatbot</span>
            </div>
            <div class="card-body p-0">
                <div class="chat-interface">
                    <div class="chat-history" id="chat-history">
                        <div class="bot-msg">Hello. I am connected to the National Disaster Database. <br><br>I know your location and current alert status. How can I help?</div>
                    </div>
                    <div id="typing-indicator" class="typing">AI is analyzing safety protocols...</div>
                    <div class="p-2 bg-white border-top d-flex gap-2">
                        <input type="text" id="user-input" class="form-control border-0 bg-light" placeholder="Ex: Where is the nearest shelter?" onkeypress="handleEnter(event)">
                        <button class="btn btn-primary rounded-circle" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-4 mb-5"><a href="index.html" class="text-decoration-none text-secondary">Log Out</a></div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">Submit Field Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="incidentForm">
                    <label class="form-label fw-bold small text-muted">CATEGORY</label>
                    <div class="row g-2 mb-3">
                        <div class="col-6"><input type="radio" class="btn-check" name="category" id="cat1" value="Medical" checked><label class="btn btn-outline-danger w-100" for="cat1"><i class="bi bi-hospital"></i> Medical</label></div>
                        <div class="col-6"><input type="radio" class="btn-check" name="category" id="cat2" value="Flood"><label class="btn btn-outline-primary w-100" for="cat2"><i class="bi bi-water"></i> Flood</label></div>
                        <div class="col-6"><input type="radio" class="btn-check" name="category" id="cat3" value="Infra"><label class="btn btn-outline-dark w-100" for="cat3"><i class="bi bi-bricks"></i> Collapse</label></div>
                        <div class="col-6"><input type="radio" class="btn-check" name="category" id="cat4" value="Food"><label class="btn btn-outline-warning w-100" for="cat4"><i class="bi bi-basket"></i> Food</label></div>
                    </div>
                    <div class="mb-3"><label class="form-label fw-bold small text-muted">EVIDENCE</label><input type="file" class="form-control" id="reportImage"></div>
                    <div class="mb-3"><label class="form-label fw-bold small text-muted">DESCRIPTION</label><textarea class="form-control" id="reportDetails" rows="3" placeholder="Describe the situation..."></textarea></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary fw-bold w-100" onclick="submitDetailedReport()">SUBMIT REPORT</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    // ================= CONFIGURATION =================
    const SUPABASE_URL = 'https://cphqdgqtrosaxosdwdrz.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwaHFkZ3F0cm9zYXhvc2R3ZHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MjU4NDQsImV4cCI6MjA3OTMwMTg0NH0.CGhmghdxQaPpD6uxDjaoAmnhZZsOKiiwacNw-ZrpDQc';
    
    // Note: In production, do not expose API keys client-side. This is for MVP/Demo only.
    const GEMINI_API_KEY = 'AIzaSyDzThTY9eY89Aa78e4chAL2DmImG8ReQDg'; 
    
    // FIX 1: Renamed variable from 'supabase' to 'supabaseClient' to avoid conflict with the library namespace
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // STATE
    let myLocation = { lat: 20.2961, lng: 85.8245 }; // Default
    const GEOFENCE_RADIUS_KM = 50;
    let currentAlertData = null; 

    // ================= 1. INIT =================
    window.onload = function() {
        initLocation();
        listenForAlerts();
    };

    function initLocation() {
        const geoText = document.getElementById('geo-text');
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                myLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                geoText.innerHTML = `<i class="bi bi-geo-alt-fill"></i> Lat: ${myLocation.lat.toFixed(2)}, Lng: ${myLocation.lng.toFixed(2)}`;
                geoText.classList.add('text-success');
                checkActiveAlerts(); 
            }, (err) => {
                console.warn("GPS Error:", err);
                useSimulationMode();
            }, { timeout: 5000, enableHighAccuracy: true });
        } else {
            useSimulationMode();
        }
    }

    function useSimulationMode() {
        const geoText = document.getElementById('geo-text');
        // Force Odisha for testing if GPS fails
        myLocation = { lat: 20.94, lng: 86.45 }; 
        geoText.innerHTML = `<i class="bi bi-pin-map-fill"></i> Odisha (Simulated)`;
        geoText.classList.add('text-warning');
        alert("⚠️ GPS Denied. Using Simulation Mode (Odisha).");
        checkActiveAlerts();
    }

    // ================= 2. REALTIME ALERTS =================
    function listenForAlerts() {
        // Updated to use supabaseClient
        supabaseClient.channel('citizen-alerts').on('postgres_changes', { event: '*', schema: 'public', table: 'alerts' }, payload => {
            // Re-check everything whenever anything changes
            checkActiveAlerts();
        }).subscribe();
    }

    async function checkActiveAlerts() {
        // Updated to use supabaseClient
        const { data } = await supabaseClient.from('alerts').select('*').eq('status', 'Active');
        
        if (!data || data.length === 0) {
            if (currentAlertData) showGreenScreen(); // Clear alert if it was resolved
            currentAlertData = null;
            return;
        }

        let foundDanger = false;

        // Loop through ALL active alerts
        for (let alert of data) {
            const alertLat = alert.latitude || 20.94; 
            const alertLng = alert.longitude || 86.45;
            const radius = alert.radius_km || 50;

            const distance = getDistanceFromLatLonInKm(myLocation.lat, myLocation.lng, alertLat, alertLng);
            
            console.log(`Checking Alert: ${alert.title} | Distance: ${distance.toFixed(1)}km | Radius: ${radius}km`);

            if (distance <= radius) {
                // Found a relevant alert!
                currentAlertData = alert;
                showRedScreen(alert, distance);
                foundDanger = true;
                break; // Stop looking, we found the danger
            }
        }

        // If we looped through all and found nothing, but screen is red -> reset to green
        if (!foundDanger && document.getElementById('status-header').classList.contains('status-danger')) {
            showGreenScreen();
        }
    }

    // ================= 3. AI AGENT LOGIC (GEMINI) =================
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const userText = inputField.value.trim();
        if (!userText) return;

        addMessage(userText, 'user-msg');
        inputField.value = '';
        document.getElementById('typing-indicator').style.display = 'block';

        let systemContext = `
            You are 'AapdaSetu', an Emergency Response AI.
            USER LOCATION: Lat ${myLocation.lat}, Lng ${myLocation.lng}.
            CURRENT ALERT: ${currentAlertData ? currentAlertData.title : "None"}.
            
            INSTRUCTIONS:
            - Keep answers under 50 words.
            - If the user is in danger, tell them to click "Report Incident".
            - Refuse non-safety questions.
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: systemContext + "\n\nUSER QUESTION: " + userText }]
                    }]
                })
            });

            const data = await response.json();
            
            if(data.error) throw new Error(data.error.message);

            const aiText = data.candidates[0].content.parts[0].text;
            document.getElementById('typing-indicator').style.display = 'none';
            addMessage(aiText, 'bot-msg'); 

        } catch (error) {
            console.error("AI Error:", error);
            document.getElementById('typing-indicator').style.display = 'none';
            addMessage(`⚠️ <strong>AI Error:</strong> ${error.message}`, 'bot-msg');
        }
    }

    function addMessage(text, className) {
        const history = document.getElementById('chat-history');
        const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
        history.innerHTML += `<div class="d-block"><div class="${className}">${formattedText}</div></div>`;
        history.scrollTop = history.scrollHeight;
    }

    function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
    function addBotMessage(text) { addMessage(text, 'bot-msg'); }

    // ================= 4. HELPERS (Geofence, UI, Reports) =================
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        // FIX 2: Corrected Haversine formula (was using cos(lat1) twice)
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }
    function deg2rad(deg) { return deg * (Math.PI/180) }

    function showRedScreen(data, distance) {
        const header = document.getElementById('status-header');
        header.className = 'status-danger';
        document.getElementById('status-content').innerHTML = `<i class="bi bi-exclamation-triangle-fill display-1 mb-2"></i><h2 class="fw-bold">${data.title}</h2><p>${data.summary}</p><div class="bg-white text-danger rounded p-2 fw-bold shadow-sm">STAY INDOORS</div>`;
        document.getElementById('distance-badge').innerText = `Impact Zone (${distance.toFixed(1)}km)`;
        document.getElementById('distance-badge').style.display = 'inline-block';
        
        // Only update chat if it's a new alert
        if (document.querySelector('.bot-msg').innerText.includes('Hello')) {
             addBotMessage(`⚠️ <strong>ALERT UPDATE:</strong> ${data.title} is active near you. I have updated my safety protocols.`);
        }
    }

    function showGreenScreen() {
        const header = document.getElementById('status-header');
        header.className = 'status-safe';
        document.getElementById('status-content').innerHTML = `<i class="bi bi-shield-check display-1 mb-2"></i><h2 class="fw-bold">You are Safe</h2><p>Threat Resolved.</p>`;
        document.getElementById('distance-badge').style.display = 'none';
    }

    async function submitDetailedReport() {
        const category = document.querySelector('input[name="category"]:checked').value;
        const details = document.getElementById('reportDetails').value;
        const imageFile = document.getElementById('reportImage').files[0];
        const submitBtn = document.querySelector('#reportModal .btn-primary');
        submitBtn.innerText = "Uploading..."; submitBtn.disabled = true;
        
        let finalImageURL = null;
        if (imageFile) {
            const fileName = `${Date.now()}_${imageFile.name.replace(/\s/g, '_')}`;
            // Updated to use supabaseClient
            const { error: uploadError } = await supabaseClient.storage.from('reports').upload(fileName, imageFile);
            if (!uploadError) {
                // Updated to use supabaseClient
                const { data: urlData } = supabaseClient.storage.from('reports').getPublicUrl(fileName);
                finalImageURL = urlData.publicUrl;
            }
        }

        // Updated to use supabaseClient
        const { error } = await supabaseClient.from('citizen_reports').insert({
            category: category, details: details, latitude: myLocation.lat, longitude: myLocation.lng, image_url: finalImageURL
        });

        submitBtn.innerText = "SUBMIT REPORT"; submitBtn.disabled = false;
        const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
        modal.hide();

        if (!error) alert("✅ Report Submitted! Response teams notified.");
        else alert("Error: " + error.message);
    }
</script>
</body>
</html>
