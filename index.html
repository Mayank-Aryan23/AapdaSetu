<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AapdaSetu | Disaster Response</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        #landing-view { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .role-card { transition: transform 0.3s; cursor: pointer; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .role-card:hover { transform: translateY(-10px); }
        .captcha-box { background-color: #f8f9fa; border: 1px dashed #ced4da; color: #495057; font-size: 1.2rem; font-family: monospace; padding: 0.2rem 0.5rem; border-radius: 5px; letter-spacing: 4px; text-align: center; }
        .location-btn-base { transition: all 0.2s; }
        .location-btn-pending { background-color: #ffc107; border-color: #ffc107; color: #212529; }
        .location-btn-success { background-color: #198754; border-color: #198754; color: white; }
    </style>
</head>
<body>

    <div id="landing-view" class="container-fluid">
        <div class="row w-100 justify-content-center gap-4">
            <div class="col-12 text-center text-white mb-5">
                <h1 class="display-4 fw-bold">AAPDASETU</h1>
                <p class="lead">Select your role to access the disaster management portal.</p>
            </div>
            <div class="col-md-4">
                <div class="card role-card p-4 text-center" onclick="selectRole('citizen')">
                    <div class="card-body">
                        <h2 class="text-success mb-3">Citizen</h2>
                        <p class="text-muted">Receive alerts, report incidents, and access safety guides.</p>
                        <button class="btn btn-outline-success w-100">Enter Portal</button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card role-card p-4 text-center" onclick="selectRole('admin')">
                    <div class="card-body">
                        <h2 class="text-primary mb-3">Authority</h2>
                        <p class="text-muted">Manage resources, verify alerts, and coordinate response.</p>
                        <button class="btn btn-outline-primary w-100">Admin Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Verification Required</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div id="admin-inputs" class="d-none">
                        <div class="mb-3"><label>Government ID</label><input type="email" class="form-control" id="adminEmail" placeholder="admin@ndma.gov.in"></div>
                        <div class="mb-3"><label>Password</label><input type="password" class="form-control" id="adminPass"></div>
                    </div>

                    <div id="citizen-inputs" class="d-none">
                        <ul class="nav nav-pills nav-fill mb-4">
                            <li class="nav-item"><a class="nav-link active" id="login-tab" href="#" onclick="showForm('login'); return false;">Login</a></li>
                            <li class="nav-item"><a class="nav-link" id="register-tab" href="#" onclick="showForm('register'); return false;">Register</a></li>
                        </ul>

                        <form id="loginForm" class="auth-form" data-form="login">
                            <div class="mb-3"><label class="form-label small fw-bold">Email</label><input type="email" class="form-control" id="loginEmail" required></div>
                            <div class="mb-3"><label class="form-label small fw-bold">Password</label><input type="password" class="form-control" id="loginPassword" required></div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-7"><input type="text" class="form-control" id="loginCaptchaInput" placeholder="CAPTCHA" required></div>
                                <div class="col-5 d-flex align-items-end justify-content-end"><div id="loginCaptchaDisplay" class="captcha-box me-2"></div><button type="button" class="btn btn-outline-secondary btn-sm" onclick="generateCaptcha('login')"><i class="bi bi-arrow-repeat"></i></button></div>
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn location-btn-base location-btn-pending fw-bold" id="loginLocationBtn" onclick="getLocation('login')"><i class="bi bi-geo-alt-fill me-2"></i> Enable Location</button>
                                <p id="loginLocationStatus" class="text-center small text-muted mb-0"></p>
                            </div>
                            <button type="submit" class="btn btn-success w-100 fw-bold py-2" id="loginBtn">ACCESS PORTAL</button>
                        </form>

                        <form id="registerForm" class="auth-form d-none" data-form="register">
                            <div class="mb-3"><label class="form-label small fw-bold">Full Name</label><input type="text" class="form-control" id="regName" required></div>
                            <div class="row">
                                <div class="col-md-8 mb-3"><label class="form-label small fw-bold">Email</label><input type="email" class="form-control" id="regEmail" required></div>
                                <div class="col-md-4 mb-3"><label class="form-label small fw-bold">Age</label><input type="number" class="form-control" id="regAge" min="18" required></div>
                            </div>
                            <div class="mb-3"><label class="form-label small fw-bold">Password</label><input type="password" class="form-control" id="regPassword" required></div>
                            <div class="mb-3"><label class="form-label small fw-bold">Re-enter Password</label><input type="password" class="form-control" id="regConfirmPassword" required></div>
                            <div class="row mb-3 align-items-center">
                                <div class="col-7"><input type="text" class="form-control" id="registerCaptchaInput" placeholder="CAPTCHA" required></div>
                                <div class="col-5 d-flex align-items-end justify-content-end"><div id="registerCaptchaDisplay" class="captcha-box me-2"></div><button type="button" class="btn btn-outline-secondary btn-sm" onclick="generateCaptcha('register')"><i class="bi bi-arrow-repeat"></i></button></div>
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button type="button" class="btn location-btn-base location-btn-pending fw-bold" id="regLocationBtn" onclick="getLocation('register')"><i class="bi bi-geo-alt-fill me-2"></i> Enable Location (Mandatory)</button>
                                <p id="regLocationStatus" class="text-center small text-muted mb-0"></p>
                            </div>
                            <button type="submit" class="btn btn-success w-100 fw-bold py-2" id="registerBtn">CREATE ACCOUNT</button>
                        </form>
                    </div>
                </div>
                <div class="modal-footer" id="modalFooter">
                    <button type="button" class="btn btn-primary w-100" id="adminAccessBtn" style="display:none" onclick="handleAdminLogin()">Access Portal</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==================== CONFIGURATION ====================
        const SUPABASE_URL = 'https://cphqdgqtrosaxosdwdrz.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwaHFkZ3F0cm9zYXhvc2R3ZHJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3MjU4NDQsImV4cCI6MjA3OTMwMTg0NH0.CGhmghdxQaPpD6uxDjaoAmnhZZsOKiiwacNw-ZrpDQc';
        
        // 2. ERROR FIXED: Renamed 'supabase' to 'supabaseClient' to avoid conflict
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentRole = null;
        let currentCaptchas = { login: '', register: '' };
        let userLocation = { lat: null, lng: null };
        const DEFAULT_LOCATION = { lat: 20.2961, lng: 85.8245 };

        document.addEventListener('DOMContentLoaded', () => {
            checkSessionAndRedirect();
            generateCaptcha('login');
            generateCaptcha('register');
            document.getElementById('loginForm').addEventListener('submit', handleCitizenLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        });

        // ==================== LOGIC ====================
        
        async function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const captchaInput = document.getElementById('registerCaptchaInput').value;
            const name = document.getElementById('regName').value;
            const age = document.getElementById('regAge').value;
            
            if (password !== confirmPassword) return alert("❌ Passwords do not match.");
            if (!validateCaptcha(captchaInput, 'register')) {
                alert("❌ Invalid CAPTCHA.");
                generateCaptcha('register');
                document.getElementById('registerCaptchaInput').value = '';
                return;
            }

            // Set Default Location if user didn't click button
            if (!userLocation.lat) {
                userLocation = { ...DEFAULT_LOCATION };
                localStorage.setItem('user_lat', userLocation.lat);
                localStorage.setItem('user_lng', userLocation.lng);
            }

            const btn = document.getElementById('registerBtn');
            btn.disabled = true; btn.innerText = "Creating Account...";

            // 3. UPDATED: Using supabaseClient instead of supabase
            const { data, error } = await supabaseClient.auth.signUp({ email, password });

            if (error) {
                alert("❌ Error: " + error.message);
                btn.disabled = false; btn.innerText = "CREATE ACCOUNT";
                return;
            }

            // Save Profile Logic
            if (data.user) {
                // 3. UPDATED: Using supabaseClient instead of supabase
                const { error: profileError } = await supabaseClient.from('profiles').insert({
                    id: data.user.id,
                    name: name,
                    age: age,
                    latitude: userLocation.lat,
                    longitude: userLocation.lng
                });

                if (profileError) {
                    console.error("Profile Error:", profileError);
                    if (profileError.code === '42P01') alert("❌ Database Error: 'profiles' table does not exist. Run the SQL I gave you!");
                    else if (profileError.code === '42501') alert("❌ Database Error: RLS is blocking insert. Disable RLS on 'profiles' table.");
                    else alert("❌ Account created but profile save failed: " + profileError.message);
                } else {
                    if (!data.session) {
                        alert("✅ Account created! Please check your email to confirm.");
                        showForm('login');
                    } else {
                        alert("✅ Registration Successful! Logging in...");
                        window.location.href = 'citizen.html';
                    }
                }
            }
            btn.disabled = false; btn.innerText = "CREATE ACCOUNT";
        }

        async function handleCitizenLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const captchaInput = document.getElementById('loginCaptchaInput').value;

            if (!validateCaptcha(captchaInput, 'login')) {
                alert("❌ Invalid CAPTCHA.");
                generateCaptcha('login');
                return;
            }

            if (!userLocation.lat) {
                userLocation = { ...DEFAULT_LOCATION };
                localStorage.setItem('user_lat', userLocation.lat);
                localStorage.setItem('user_lng', userLocation.lng);
            }

            // 3. UPDATED: Using supabaseClient instead of supabase
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) alert("❌ Login Failed: " + error.message);
            else window.location.href = 'citizen.html';
        }

        function getLocation(target) {
            const prefix = target === 'register' ? 'reg' : 'login'; 
            const btn = document.getElementById(`${prefix}LocationBtn`);
            const status = document.getElementById(`${prefix}LocationStatus`);
            
            if(!btn) return console.error("Button not found for", prefix);

            btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Locating...';
            status.innerText = "Requesting GPS access...";

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    localStorage.setItem('user_lat', userLocation.lat);
                    localStorage.setItem('user_lng', userLocation.lng);
                    
                    status.innerText = "✅ Location Verified";
                    status.className = "text-center small text-success mb-0";
                    btn.className = "btn location-btn-base location-btn-success fw-bold";
                    btn.innerText = "✅ Location Enabled";
                    btn.disabled = false;
                }, err => {
                    console.warn(err);
                    status.innerText = "❌ GPS Denied. Using Manual Mode.";
                    status.className = "text-center small text-danger mb-0";
                    btn.className = "btn location-btn-base btn-danger fw-bold";
                    btn.innerText = "GPS Failed";
                    btn.disabled = false;
                });
            }
        }

        // ... Helpers ...
        function selectRole(role) {
            currentRole = role;
            new bootstrap.Modal(document.getElementById('authModal')).show();
            document.getElementById('admin-inputs').classList.add('d-none');
            document.getElementById('citizen-inputs').classList.add('d-none');
            document.getElementById('adminAccessBtn').style.display = 'none';

            if (role === 'admin') {
                document.getElementById('modalTitle').innerText = "Admin Authorization";
                document.getElementById('admin-inputs').classList.remove('d-none');
                document.getElementById('adminAccessBtn').style.display = 'block';
            } else {
                document.getElementById('modalTitle').innerText = "Citizen Verification";
                document.getElementById('citizen-inputs').classList.remove('d-none');
                showForm('login');
            }
        }

        function showForm(target) {
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('d-none'));
            document.getElementById(`${target}Form`).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
            document.getElementById(`${target}-tab`).classList.add('active');
            generateCaptcha(target);
        }

        function generateCaptcha(target) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let c = ''; for (let i = 0; i < 5; i++) c += chars.charAt(Math.floor(Math.random() * chars.length));
            currentCaptchas[target] = c;
            const el = document.getElementById(`${target === 'register' ? 'register' : 'login'}CaptchaDisplay`);
            if(el) el.innerText = c;
        }

        function validateCaptcha(input, target) { return input.toUpperCase() === currentCaptchas[target].toUpperCase(); }
        
        // ==================== ADMIN AUTH LOGIC ====================
        async function handleAdminLogin() {
            const emailInput = document.getElementById('adminEmail');
            const passInput = document.getElementById('adminPass');
            const loginBtn = document.getElementById('adminAccessBtn'); 

            const email = emailInput.value.trim();
            const password = passInput.value.trim();

            if (!email || !password) {
                alert("Please enter Government ID and Password.");
                return;
            }

            const originalText = loginBtn.innerText;
            loginBtn.innerText = "Verifying Credentials...";
            loginBtn.disabled = true;

            try {
                // 3. UPDATED: Using supabaseClient
                const { data, error } = await supabaseClient
                    .from('admin_directory')
                    .select('*')
                    .eq('email', email)
                    .eq('password', password)
                    .single(); 

                if (error || !data) {
                    console.warn("Login Failed:", error);
                    alert("❌ Access Denied: Invalid Government Credentials.");
                    
                    loginBtn.innerText = originalText;
                    loginBtn.disabled = false;
                } else {
                    console.log("Admin Verified:", data.name);
                    alert(`✅ Welcome, ${data.name}.\nAccessing Secure Command Center...`);
                    
                    sessionStorage.setItem('admin_logged_in', 'true');
                    sessionStorage.setItem('admin_name', data.name);

                    window.location.href = 'admin/index.html';
                }

            } catch (err) {
                console.error("Unexpected Error:", err);
                alert("System Error. Check console.");
                loginBtn.innerText = originalText;
                loginBtn.disabled = false;
            }
        }

        async function checkSessionAndRedirect() {
            // 3. UPDATED: Using supabaseClient
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) console.log("Session active");
        }
    </script>
</body>
</html>
